window.wp=window.wp||{},function(t){var a=function(){function a(){document.body.className=document.body.className.replace(/no-js/,"js")}function i(){t("body").hasClass("short-header")||(P="innerHeight"in window?window.innerHeight:document.documentElement.offsetHeight,P<t(document).height()-200&&t(".cacap-hero-row").waypoint("sticky",{offset:10,wrapper:'<div class="cacap-hero-row-sticky" />'}))}function e(){ha=t("#cacap-widget-order"),ra.sortable({placeholder:"ui-state-highlight",containment:t(".cacap-widgets-edit"),handle:".cacap-drag-handle",stop:function(){ha.val(t(this).sortable("toArray"))}})}function n(){t("article.richtext").each(function(){t(this).hallo({toolbar:"halloToolbarFixed",toolbarOptions:{parentElement:t(this).closest(".cacap-click-to-edit")},plugins:{halloformat:{},hallolink:{},hallojustify:{},hallolists:{},halloheadings:{}}})})}function c(){sa=t(".cacap-widget-positions"),la=sa.find(".cacap-positions-positions"),pa=sa.find(".cacap-positions-static-text"),sa.length&&(m(),sa.html(sa.html().replace(/\bnewwidgetkey\b/g,"cacap_positions")),A(sa),T(sa)),ra.on("click",".cacap-add-position",function(){return da=t(this).closest(".cacap-widget-positions"),b(),!1}),ra.on("click",".cacap-delete-position",function(){t(this).parent("li").remove()})}function o(){Q=0,t("#cacap-new-widget-types li").on("click",function(a){a.preventDefault(),ia=t(this),v()})}function s(){$=!1,t("#cacap-edit-form input:not(:submit), #cacap-edit-form textarea, #cacap-edit-form select").change(function(){$=!0}),t("#cacap-edit-form input:submit").on("click",function(){$=!1}),window.onbeforeunload=function(){return $?"Are you sure you want to leave?":void 0}}function l(){t("#cacap-edit-form").on("keydown","input:not(:submit), textarea",function(a){return O=a.keyCode?a.keyCode:a.which,X=t(this),27===O?(X.closest(".cacap-show-on-edit").find(".cacap-cancel").trigger("click"),!1):13!==O||"textarea"===this.type||X.hasClass("ui-autocomplete-input")?void 0:(X.closest(".cacap-show-on-edit").find(".cacap-ok").trigger("click"),!1)})}function p(){S=t("div.field_about-you textarea"),0!==S.length&&(S.after('<div class="cacap-char-count-gloss">Using <span class="cacap-char-count">0</span> of '+fa+' characters<span class="cacap-char-count-warning"> (additional characters will be trimmed)</span></div>'),V=t(".cacap-char-count-gloss"),D(S),S.on("keyup",function(){D(S)}))}function d(){"ok"===Z?ta.find(".editable-content-stash").val(ta.find(".editable-content").html()):ta.find(".editable-content").html(ga[K]),ta.removeClass("editing"),x()}function r(){aa.closest(".cacap-widget-section-editable").hasClass("cacap-widget-title")?"ok"===Z?ta.find(".editable-content-stash").val(ta.find(".editable-content").html()):ta.find(".editable-content").html(ga[K]):"ok"===Z||ta.find("input.cacap-edit-input").val(ga[K]),ta.removeClass("editing"),x()}function h(){"ok"===Z&&m(),ta.removeClass("editing"),x()}function f(){ga[K]=aa.html(),ta.addClass("editing")}function u(){ga[K]=ta.find("input.cacap-edit-input").val(),ta.addClass("editing")}function g(){ta.addClass("editing")}function w(t){return widget_type_regex=/cacap\-widget\-([a-zA-Z0-9\-]+)/,t.match(widget_type_regex).pop()}function m(){B=[],sa=t(".cacap-widget-positions"),la=sa.find(".cacap-positions-positions"),la.find(".cacap-position").each(function(){W=t(this),"new"!==W.attr("id").split("-").pop()&&B.push({college:W.find(".cacap-position-field-college").val(),department:W.find(".cacap-position-field-department").val(),title:W.find(".cacap-position-field-title").val()})}),I="";for(var a=0;a<B.length;a++)J="",B[a].college&&B[a].department&&B[a].title&&(J+='<span class="cacap-positions-title">'+B[a].title+"</span> ",J+='<span class="cacap-positions-department">'+B[a].department+"</span>",J+='<span class="cacap-positions-college">'+B[a].college+"</span>"),J.length&&(I+="<li>"+J+"</li>");oa=sa.find(".cacap-positions-static-text"),oa.length||(sa.find(".cacap-widget-content").append('<div class="cacap-positions-static-text"></div>'),oa=sa.find(".cacap-positions-static-text")),I.length&&(I='<ul class="cacap-positions-list">'+I+"</ul>"),oa.html(I)}function b(){ca=da.find(".cacap-position-new").children("li").clone(),G=da.find(".cacap-position").length,q="cacap-position-"+G,ca.find(".cacap-position").removeAttr("id").attr("id",q),ca.find("label").each(function(){na=t(this),na.attr("for",na.attr("for").replace("cacap-position-new",q))}),ca.find("input,select").each(function(){ea=t(this),ea.attr("id",ea.attr("id").replace("cacap-position-new",q)),ea.attr("name",ea.attr("name").replace(/\bnew\b/,G))}),ca.find(".cacap-delete-position").remove(),t(".cacap-positions-positions").prepend(ca.wrap("<li></li>")),A(da),T(da),H()}function v(){return ia.hasClass("cacap-has-max")?!1:(Q++,R=ia.attr("id").slice(17),U=t("#cacap-widget-prototype-"+R).html(),U=U.replace(/newwidgetkey/g,"newwidget"+Q),K="cacap-widget-newwidget"+Q,ra.append('<li id="'+K+'" class="cacap-widget-'+R+'">'+U+"</li>"),j(),M.push(K),ha.val(M),da=t("#"+K),da.addClass("cacap-widget-"+R),ia.hasClass("disable-multiple")&&ia.addClass("cacap-has-max"),da.find("article.editable-content").css("min-height","2em").attr("contenteditable","true"),da.find(".cacap-widget-title").attr("id",K+"-title"),da.find(".cacap-widget-content").attr("id",K+"-content"),"positions"==R&&b(da),n(),t.scrollTo(da.offset().top-230+"px",500),void 0)}function y(){t("body").on("mousedown",function(a){if(aa=t(a.target),ta=aa.closest(".cacap-click-to-edit"),F=ta.length?ta.attr("id"):"",!ua.length||F===ua||aa.closest(".ui-autocomplete").length||aa.closest(".hallolink-dialog").length||(Y=t("#"+ua),N=Y.offset(),t.scrollTo(N.top-230+"px",500),Y.addClass("warn"),setTimeout(function(){Y.removeClass("warn")},800),a.preventDefault()),F.length&&(!ua.length&&F.length&&C(F),ta.hasClass("cacap-widget-section-editable")))switch(L=aa.hasClass("button"),L&&(Z=aa.hasClass("cacap-ok")?"ok":"cancel"),da=ta.closest("ul#cacap-widget-list li"),K=da.attr("id"),R=w(da.attr("class"))){case"positions":L?h():g();break;case"rss":case"twitter":L?r():u();break;default:L?d():aa.closest("article").hasClass("editable-content")&&f()}})}function k(){ra.on("click",".cacap-widget-remove",function(){return da=t(this).closest("#cacap-widget-list li"),_(),!1})}function C(a){ua=a,ra.find(".cacap-click-to-edit").each(function(){ua===this.id?t(this).find("article.editable-content").attr("contenteditable",!0):t(this).find("article.editable-content").attr("contenteditable",!1)}),ra.addClass("currently-editing")}function x(){ua="",ra.find("article.editable-content").attr("contenteditable",!0),ra.removeClass("currently-editing")}function _(){j(),K=da.attr("id"),M.splice(t.inArray(K,M),1),ha.val(M),R=w(da.attr("class")),ia=t("#cacap-new-widget-"+R),ia.hasClass("disable-multiple")&&ia.removeClass("cacap-has-max"),da.remove()}function j(){M=ha.val().split(",")}function A(a){if(a){var i=ajaxurl+"?action=cacap_position_suggest";a.find(".cacap-position-field-autocomplete").each(function(){t(this).autocomplete({source:i+"&field="+t(this).data("field-type"),minLength:2})})}}function T(t){t&&t.find(".cacap-positions-positions").sortable({placeholder:"ui-state-highlight",containment:t,axis:"y",handle:".cacap-position-drag-handle",stop:function(){H()}})}function H(){var a=1;sa.find(".cacap-position").each(function(){"cacap-position-add-new"!==this.id&&(this.id="cacap-position-"+a,t(this).siblings(".cacap-delete-position").attr("id","cacap-delete-position-"+a),t(this).find("input,select").each(function(){console.log(t(this).attr("name").replace(/(\[content\]\[)([0-9]+)\]/,"$1"+a+"]")),t(this).attr("name",t(this).attr("name").replace(/(\[content\]\[)([0-9]+)\]/,"$1"+a+"]"))}),a++)})}function D(t){z=t.val().length,V.find("span.cacap-char-count").html(z),E=z>fa?"cacap-length-red":z>fa-40?"cacap-length-yellow":"cacap-length-green",V.removeClass("cacap-length-red cacap-length-yellow cacap-length-green"),V.addClass(E)}var E,N,$,z,F,L,O,Q,U,Z,q,B,G,I,J,K,M,P,R,S,V,W,X,Y,ta,aa,ia,ea,na,ca,oa,sa,la,pa,da,ra,ha,fa=350,ua="",ga={};t(document).ready(function(){a(),i(),ra=t("#cacap-widget-list"),t("body").hasClass("profile-edit")&&(e(),n(),c(),o(),s(),l(),p(),y(),k())})};wp.cacap=new a}(jQuery);